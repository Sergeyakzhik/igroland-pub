import React, { useState, useEffect } from 'react';
import ReactTooltip from 'react-tooltip';
import * as d3 from "d3";
import {
    ComposableMap,
    ZoomableGroup,
    Geographies,
    Geography,
    Markers,
    Marker,
} from 'react-simple-maps';

import blue_logo from '../../resources/images/blue_logo.svg';

const Tooltip = ({ value = {} }) => (
    <div>
        <p className="blue-link">{value.name}</p>
        <p>{value.address}</p>
        <a className="blue-link" href={value.site}>{value.site}</a>
        <p>
            {value.tests && value.tests.map((item, ind) => (
                <span key={"test-" + ind} className="blue-link">{item}  </span>
            ))}
        </p>
    </div>
);

const Map = ({ data, filteredIDs, ...props }) => {

    useEffect(() => {
        updateChart();
    }, []);

    const updateChart = () => {
        const zoomed = () => {
            const pinScale = 1 / d3.event.transform.k;

            d3.selectAll(".pin").each(function() {
                d3.select(this).attr("transform", `translate(${-15.6 * pinScale + 2}, ${-23.3 * pinScale - 2}) scale(${pinScale})`)
            });
            d3.select(".rsm-zoomable-group").attr("transform", d3.event.transform);
        }
        
        const zoom = d3.zoom().scaleExtent([1, 20]).on("zoom", zoomed);
        
        d3.select("#map").call(zoom);
    };

    return (
        <>
            <div className="image-wrapper map-logo">
                <img src={blue_logo} alt="logo" />
            </div>
            {data.length > 0 && data.map(item => (
                <ReactTooltip 
                    clickable={true} 
                    delayHide={100} 
                    className="map-tooltip" 
                    place="top" 
                    type="light" 
                    effect="solid" 
                    id={item.value}
                    key={item.value}
                >
                    <Tooltip value={item} />
                </ReactTooltip>
            ))} 
            <div id="map" className="map-box" onClick={props.closeDropdowns}>
                <ComposableMap
                    projectionConfig={{
                        scale: 210,
                        yOffset: 20,
                        rotation: [-11, 0, 0]
                    }}
                    width={980}
                    height={470}
                >
                    <ZoomableGroup disablePanning center={[11, -5.9]}>
                        <Geographies geography="/world.geo.json">
                            {(geographies, projection) => (
                                geographies.map((geography, i) => (
                                    <Geography
                                        key={i}
                                        geography={geography}
                                        projection={projection}
                                        style={{
                                            default: {
                                                fill: "#F6F6F6",
                                                stroke: "#000",
                                                strokeWidth: "0.1px",
                                                outline: "none"
                                            },
                                            hover: {
                                                fill: "#FFF",
                                                stroke: "#000",
                                                strokeWidth: "0.1px",
                                                outline: "none",
                                                cursor: 'pointer'
                                            }
                                        }}
                                    />)
                                )
                            )}
                        </Geographies>
                        <Markers>
                            {data.length > 0 && data.map((marker, i) => (
                                <Marker
                                    key={marker.name}
                                    marker={{
                                        ...marker,
                                        coordinates: [marker.coordinates[1], marker.coordinates[0]]
                                    }}
                                >
                                    <g className={`pin ${!filteredIDs.includes(marker.id) ? 'hidden' : ''}`} transform="translate(-13.6, -25.3) scale(1)" data-tip data-for={marker.value} data-iscapture="true">
                                        <svg width="23px" height="31px" viewBox="0 0 23 31" version="1.1" xmlns="http://www.w3.org/2000/svg">
                                            <title>D18D5BB7-4468-405C-A87B-743A4D5DBC51</title>
                                            <desc>Created with sketchtool.</desc>
                                            <defs>
                                                <path d="M7.81714297,0 C3.51524577,0 0.0152228574,3.53367698 0.0152228574,7.87693858 C0.0152228574,9.18078475 0.338102862,10.473554 0.951908586,11.6202002 L7.39049154,23.3769234 C7.47620583,23.5336619 7.63954297,23.6307696 7.81714297,23.6307696 C7.99474298,23.6307696 8.15808012,23.5336619 8.24379441,23.3769234 L14.6847545,11.6163233 C15.2961831,10.473554 15.6190631,9.1807386 15.6190631,7.87689243 C15.6190631,3.53367698 12.1190402,0 7.81714297,0 Z" id="path-1"></path>
                                                <filter x="-51.3%" y="-16.9%" width="202.5%" height="167.7%" filterUnits="objectBoundingBox" id="filter-2">
                                                    <feOffset dx="0" dy="4" in="SourceAlpha" result="shadowOffsetOuter1"></feOffset>
                                                    <feGaussianBlur stdDeviation="2" in="shadowOffsetOuter1" result="shadowBlurOuter1"></feGaussianBlur>
                                                    <feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.398464816 0" type="matrix" in="shadowBlurOuter1"></feColorMatrix>
                                                </filter>
                                            </defs>
                                            <g id="GP-Location" stroke="none" strokeWidth="1" fill="none" fillRule="evenodd">
                                                <g id="Services-Locations-Initial-Page" transform="translate(-709.000000, -1256.000000)" fillRule="nonzero">
                                                    <g id="map" transform="translate(201.000000, 705.000000)">
                                                        <g id="icon_pin-3" transform="translate(512.000000, 551.000000)">
                                                            <g id="Shape">
                                                                <use fill="black" fillOpacity="1" filter="url(#filter-2)" xlinkHref="#path-1"></use>
                                                                <use fill="#0BA6BF" xlinkHref="#path-1"></use>
                                                            </g>
                                                            <g id="Group" transform="translate(3.657143, 3.692308)" fill="#FFFFFF">
                                                                <path d="M4.12892208,4.55932874 C3.61866437,4.55932874 3.20733418,4.13862943 3.20733418,3.62853152 C3.20733418,3.11843361 3.62387108,2.69773431 4.12892208,2.69773431 C4.63397308,2.69773431 5.05050999,3.11317487 5.05050999,3.62853152 C5.05050999,4.14388817 4.63917979,4.55932874 4.12892208,4.55932874 L4.12892208,4.55932874 Z M5.58680126,2.16660143 L4.12892208,2.16660143 C3.34791538,2.16660143 2.7126966,2.84497906 2.7126966,3.63379026 C2.7126966,4.42260146 3.36353552,5.07994413 4.14454222,5.07994413 C4.14974893,5.07994413 4.99844288,5.05890917 4.98802945,5.53745463 C4.98282274,5.83720288 4.0456147,6.45247562 4.0456147,6.45247562 L4.0456147,7.0099022 C4.0456147,7.0099022 5.41497978,6.21057352 5.54514756,5.57952456 C5.66490193,5.01158049 5.11299052,4.82752455 5.01926972,4.78019588 C5.34208582,4.51725881 5.54514756,4.07026579 5.54514756,3.62327278 C5.54514756,3.25516089 5.40456636,2.98696508 5.18067777,2.62411193 L5.58680126,2.62411193 L5.58680126,2.16660143 L5.58680126,2.16660143 Z" id="Shape"></path>
                                                                <path d="M1.75986843,1.51977625 C1.84317581,1.44089513 1.9316899,1.36727275 2.02541071,1.29365037 L1.73383487,0.888727286 C1.62449393,0.972867147 1.52035971,1.06226575 1.41622548,1.15692309 L1.75986843,1.51977625 Z" id="Path"></path>
                                                                <path d="M2.17119862,1.18847554 C2.26491943,1.1201119 2.36384694,1.06226575 2.46277446,1.0044196 L2.22847245,0.562685323 C2.10871809,0.63104896 1.99417044,0.704671339 1.87962279,0.783552459 L2.17119862,1.18847554 Z" id="Path"></path>
                                                                <path d="M1.31729797,2.01409793 C1.41622548,1.88788814 1.52035971,1.76693709 1.62970065,1.65124478 L1.2860577,1.28839163 C1.15588991,1.4251189 1.03092884,1.56710492 0.916381194,1.71434968 L1.31729797,2.01409793 Z" id="Path"></path>
                                                                <path d="M0.562324823,3.89672733 C0.583151669,3.7021539 0.619598648,3.50758047 0.671665761,3.31826578 L0.192648319,3.17102103 C0.130167783,3.39188816 0.0885140926,3.6127553 0.0624805359,3.84413992 L0.562324823,3.89672733 Z" id="Path"></path>
                                                                <path d="M0.999688575,2.49790214 C1.06216911,2.38220983 1.13506307,2.26651752 1.20795703,2.15608395 L0.807040256,1.86159443 C0.718526163,1.99306297 0.635218782,2.12979024 0.557118112,2.26651752 L0.999688575,2.49790214 Z" id="Path"></path>
                                                                <path d="M0.723732875,3.14472732 C0.775799988,2.9764476 0.843487235,2.81868536 0.916381194,2.66092312 L0.473810731,2.4295385 C0.385296638,2.61359444 0.307195968,2.80290913 0.244715432,2.99748256 L0.723732875,3.14472732 Z" id="Path"></path>
                                                                <path d="M2.6189758,0.915020993 C2.90534492,0.767776235 3.21254089,0.657342667 3.53015028,0.58897903 L3.43642948,0.0946573441 C3.06675297,0.173538464 2.7126966,0.305006998 2.38467379,0.47328672 L2.6189758,0.915020993 Z" id="Path"></path>
                                                                <path d="M7.30501599,6.72067143 C7.10195425,6.97834975 6.86244553,7.21499311 6.59690325,7.41482529 L6.88327238,7.82500711 C7.19046834,7.59888123 7.46121733,7.32542668 7.70072605,7.02567843 L7.30501599,6.72067143 Z" id="Path"></path>
                                                                <path d="M3.61866437,0.063104896 L3.71238518,0.557426582 C3.84775967,0.536391616 3.98313417,0.520615392 4.11850866,0.51009791 L4.10288853,0.00525874134 C3.93627376,0.015776224 3.77486571,0.0368111894 3.61866437,0.063104896" id="Path"></path>
                                                                <path d="M8.12767638,4.3384616 C8.12767638,4.72760846 8.07040256,5.1009791 7.96106162,5.45857351 L8.43487235,5.61633575 C8.55983342,5.21141267 8.62231396,4.78545462 8.62231396,4.3384616 C8.62231396,4.33320286 8.62231396,4.32794412 8.62231396,4.32268538 L8.12767638,4.3384616 L8.12767638,4.3384616" id="Path"></path>
                                                                <path d="M8.37239182,2.86075529 L7.90899451,3.04481123 C8.03395558,3.39188816 8.11205625,3.7652588 8.12767638,4.15440566 L8.62752067,4.14388817 C8.60148711,3.69163642 8.51297302,3.26041963 8.37239182,2.86075529" id="Path"></path>
                                                                <path d="M7.19567506,1.82478324 C7.46121733,2.13504898 7.68510592,2.48738465 7.84130726,2.87127277 L8.30470457,2.68721682 C8.12246967,2.24548255 7.87254753,1.83530073 7.56014485,1.48296506 L7.19567506,1.82478324 Z" id="Path"></path>
                                                                <path d="M5.89920393,0.846657355 C6.3417744,1.05174827 6.73748446,1.3357203 7.07071398,1.68805597 L7.44039049,1.34623778 C7.06030056,0.941314699 6.60210996,0.615272736 6.09705897,0.383888118 L5.89920393,0.846657355 Z" id="Path"></path>
                                                                <path d="M5.62845495,8.47709104 L5.46704689,7.99854557 C5.18588448,8.08794418 4.89430865,8.14053159 4.59231939,8.16156656 L4.61314624,8.66640572 C4.9619959,8.64537076 5.30563884,8.57700712 5.62845495,8.47709104" id="Path"></path>
                                                                <path d="M7.90899451,5.63211197 C7.78924015,5.97393016 7.62262538,6.28945464 7.41435693,6.57868541 L7.81006699,6.88369241 C8.04957571,6.55239171 8.24222403,6.18427981 8.37759853,5.79513295 L7.90899451,5.63211197 Z" id="Path"></path>
                                                                <path d="M6.45111534,7.52000011 C6.20119319,7.69353858 5.92523749,7.83552459 5.63886837,7.94069942 L5.80027642,8.41924488 C6.13350594,8.29829383 6.45111534,8.13001411 6.74269117,7.93018194 L6.45111534,7.52000011 Z" id="Path"></path>
                                                                <path d="M4.30074356,0.504839168 C4.31115698,0.504839168 4.3215704,0.504839168 4.33719054,0.504839168 C4.83182811,0.504839168 5.30563884,0.599496512 5.73779588,0.778293718 L5.9304442,0.31552448 C5.43580663,0.110433568 4.89430865,0 4.33198383,0 C4.31636369,0 4.30074356,0 4.27991671,0 L4.30074356,0.504839168 Z" id="Path"></path>
                                                                <path d="M0.536291267,4.3384616 C0.536291267,4.249063 0.541497978,4.16492314 0.546704689,4.08078328 L0.0520671133,4.03345461 C0.046860402,4.13337069 0.0416536906,4.23328678 0.0416536906,4.3384616 C0.0416536906,4.45941265 0.046860402,4.5803637 0.0572738246,4.70131476 L0.551911401,4.64872734 C0.541497978,4.54881126 0.536291267,4.44363643 0.536291267,4.3384616" id="Path"></path>
                                                                <path d="M4.4100845,8.17208404 C4.38405094,8.17208404 4.35801738,8.17208404 4.33198383,8.17208404 C4.07685497,8.17208404 3.83213954,8.14579033 3.59263082,8.09846166 L3.48328988,8.59278334 C3.75924558,8.6506295 4.04040799,8.67692321 4.33198383,8.67692321 C4.3684308,8.67692321 4.39967107,8.67692321 4.43091134,8.67692321 L4.4100845,8.17208404 Z" id="Path"></path>
                                                                <path d="M0.708112741,5.48486721 C0.640425493,5.27451756 0.593565091,5.05365042 0.567531535,4.83278329 L0.0728939586,4.8853707 C0.104134227,5.14830777 0.161408051,5.40072735 0.239508721,5.6478882 L0.708112741,5.48486721 Z" id="Path"></path>
                                                                <path d="M1.07258253,6.29997212 C0.952828173,6.09488121 0.848693947,5.87927281 0.770593277,5.65840568 L0.296782546,5.82142666 C0.39050335,6.08436373 0.51025771,6.33678331 0.650838916,6.56816793 L1.07258253,6.29997212 Z" id="Path"></path>
                                                                <path d="M2.43153419,7.65672739 C2.19202547,7.51474137 1.96813688,7.34646165 1.76507514,7.15714696 L1.42143219,7.52000011 C1.6557342,7.74086725 1.91606977,7.93544068 2.19723218,8.09846166 L2.43153419,7.65672739 Z" id="Path"></path>
                                                                <path d="M1.62970065,7.03093717 C1.45787917,6.8573987 1.30167783,6.66282527 1.16630334,6.45773436 L0.74455972,6.72593017 C0.90076106,6.96783227 1.08299596,7.18869941 1.28085099,7.39379032 L1.62970065,7.03093717 Z" id="Path"></path>
                                                                <path d="M3.41560263,8.06165047 C3.1240268,7.98802809 2.8480711,7.88285326 2.58773553,7.74612599 L2.34822681,8.18786026 C2.65021607,8.3456225 2.96782546,8.47183229 3.30626169,8.55597216 L3.41560263,8.06165047 Z" id="Path"></path>
                                                            </g>
                                                        </g>
                                                    </g>
                                                </g>
                                            </g>
                                        </svg>
                                    </g>
                                </Marker>
                            ))}
                        </Markers>
                    </ZoomableGroup>
                </ComposableMap>
            </div>
        </>
    );
};

export default Map;


